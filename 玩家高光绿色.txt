local function addHighlightAndName(player)
    if player == game.Players.LocalPlayer then return end
    player.CharacterAdded:Connect(function(character)
        -- 添加绿色高光
        if not character:FindFirstChild("ESPHighlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESPHighlight"
            highlight.FillColor = Color3.fromRGB(0,255,0)
            highlight.OutlineColor = Color3.fromRGB(0,255,0)
            highlight.Parent = character
        end
        -- 添加头顶名字
        local head = character:FindFirstChild("Head")
        if head and not head:FindFirstChild("ESPName") then
            local billboard = Instance.new("BillboardGui")
            billboard.Name = "ESPName"
            billboard.Adornee = head
            billboard.Size = UDim2.new(0, 200, 0, 50)
            billboard.StudsOffset = Vector3.new(0, 2, 0)
            billboard.AlwaysOnTop = true

            local textLabel = Instance.new("TextLabel")
            textLabel.Parent = billboard
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.Text = player.Name
            textLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            textLabel.TextStrokeTransparency = 0.5
            textLabel.Font = Enum.Font.SourceSansBold
            textLabel.TextScaled = true

            billboard.Parent = head
        end
    end)
    -- 已存在角色也处理
    if player.Character then
        local character = player.Character
        if not character:FindFirstChild("ESPHighlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESPHighlight"
            highlight.FillColor = Color3.fromRGB(0,255,0)
            highlight.OutlineColor = Color3.fromRGB(0,255,0)
            highlight.Parent = character
        end
        local head = character:FindFirstChild("Head")
        if head and not head:FindFirstChild("ESPName") then
            local billboard = Instance.new("BillboardGui")
            billboard.Name = "ESPName"
            billboard.Adornee = head
            billboard.Size = UDim2.new(0, 200, 0, 50)
            billboard.StudsOffset = Vector3.new(0, 2, 0)
            billboard.AlwaysOnTop = true

            local textLabel = Instance.new("TextLabel")
            textLabel.Parent = billboard
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.Text = player.Name
            textLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            textLabel.TextStrokeTransparency = 0.5
            textLabel.Font = Enum.Font.SourceSansBold
            textLabel.TextScaled = true

            billboard.Parent = head
        end
    end
end

-- 启用玩家高亮和名字显示
for _, player in ipairs(game.Players:GetPlayers()) do
    addHighlightAndName(player)
end
game.Players.PlayerAdded:Connect(addHighlightAndName)